<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
.display {
    font-size: 54px;
    font-weight: bold;
}
.display-title {
    display: inline-block;
    width: 360px;
}
button {
    font-size: 48px;
    font-weight: bold;
    padding: 12px;
}
#start-button, #end-button, #reset-button {
    font-size: 64px;
    padding: 24px;
}
.minus {
    background-color: lightblue;
}
.plus {
    background-color: salmon;
}
.selected {
    background-color: yellow;
}
html {
  touch-action: manipulation;
}
.mt-8 {
    margin-top: 8px;
}
#posession-input button {
    margin: 0px;
    font-size: 48px;
    width: 140px;
    height: 140px;
}
#role-input button {
    margin: 0px;
    font-size: 56px;
    width: 140px;
    height: 140px;
}
#number-input button {
    margin: 0px;
    font-size: 64px;
    width: 140px;
    height: 140px;
}
#record-table {
    font-size: 40px;
    border-collapse: collapse;
}
#all-rate {
    font-size: 80px;
    font-weight: bold;
}
#record-table th, #record-table td {
    border: 2px solid #888;
    text-align: center;
    width: 140px;
}
</style>
<script>
const localStrageKey = 'record-key';
let records = [];
let selectedDisplay = 'none';
let displayPosession = '02500'; 
let displayRole = '0000'; 
let preEditDisplay = '';
$(init);
/* TODO
データそのものを記憶。その時に名前を付けられるようにする
そのロード時は一覧から選択できるようにする
直近10個のみ記憶できるようにしておけば、消す手間がなくなる
*/
function init() {
    loadRecords();
    attachEvents();
    updateView();
}
function attachEvents() {
    $('#posession-display').click(() => {
        resetDisplay();
        selectPosession();        
        updateView();
    });
    $('#role-display').click(() => {
        resetDisplay();
        selectRole();
        updateView();
    });
    $('#posession-input button').click(e => {
        clickPosessionButton(e);
        updateView();
    });
    $('#role-input button').click(e => {
        clickRoleButton(e);
        updateView();
    });
    $('#number-input button').click(e => {
        clickNumberButton(e);
        updateView();
    });
    $('#start-button').click(() => {
        resetDisplay();
        clickStartButton();
        selectedDisplay = 'none';
        saveRecords();
        updateView();
    });
    $('#end-button').click(() => {
        resetDisplay();
        clickEndButton();
        selectedDisplay = 'none';
        saveRecords();
        updateView();
    });
    $('#reset-button').click(() => {
        resetDisplay();
        clickResetButton();
        selectedDisplay = 'none';
        saveRecords();
        updateView();
    });
    $(document).on('click', '.delete-button', e => {
        resetDisplay();
        clickDeleteButton(e);
        saveRecords();
        updateView();
    });
}
function resetDisplay() {
    if(selectedDisplay === 'posession') {
        displayPosession = preEditDisplay;
    } else if(selectedDisplay === 'role') {
        displayRole = preEditDisplay;
    }
}
function selectPosession() {
    if(selectedDisplay === 'posession') { return; }
    selectedDisplay = 'posession';
    preEditDisplay = displayPosession;
}
function selectRole() {
    if(selectedDisplay === 'role') { return; }
    selectedDisplay = 'role';
    preEditDisplay = displayRole;
}
function clickPosessionButton(e) {
    const val = getValue(e.target.id);
    let currentVal = parseInt(preEditDisplay, 10);
    currentVal += val;
    displayPosession = (currentVal + '').padStart(5, '0'); // to string
    preEditDisplay = displayPosession;
}
function clickRoleButton(e) {
    const val = getValue(e.target.id);
    let currentVal = parseInt(preEditDisplay, 10);
    currentVal += val;
    displayRole = (currentVal + '').padStart(4, '0'); // to string
    preEditDisplay = displayRole;
}
function clickNumberButton(e) {
    const splits = e.target.id.split('-');
    if(splits.length !== 2) { throw 'fatal error.'; }
    const val = parseInt(splits[0], 0);
    let currentString;
    if(selectedDisplay === 'posession') {
        currentString = displayPosession;
    } else if(selectedDisplay === 'role') {
        currentString = displayRole;
    } else {
        throw 'fatal error.';
    }
    const astIndex = currentString.indexOf('*');
    const editIndex = astIndex < 0 ? 0 : astIndex;
    currentString = Array.from(currentString).map((e, i) => {
        if(i === editIndex) { return val; }
        else if(i === editIndex + 1) { return '*'; }
        else { return e; }
    }).join('');
    if(selectedDisplay === 'posession') {
        displayPosession = currentString;
        if(editIndex === displayPosession.length - 1) {
            console.log('finish');
            preEditDisplay = displayPosession;
        }        
    } else if(selectedDisplay === 'role') {
        displayRole = currentString;
        if(editIndex === displayRole.length - 1) {
            console.log('finish');
            preEditDisplay = displayRole;
        }   
    } 
}
function clickStartButton() {
    const record = {
        begin: {
            posession: parseInt(displayPosession, 10),
            role: parseInt(displayRole, 10),
        },
        end: null,
    };
    if(records.length && records[records.length - 1].end === null) {
        records[records.length - 1] = record;
    } else {
        records.push(record);
    }
}
function clickEndButton() {
    records[records.length - 1].end = {
        posession: parseInt(displayPosession, 10),
        role: parseInt(displayRole, 10),
    };
}
function clickResetButton() {
    records = [];
}
function clickDeleteButton(e) {
    const buttonId = e.target.id;
    const splits = buttonId.split('-');
    if(splits.length !== 3) { throw 'fatal error.'; }
    let index = parseInt(splits[0], 10);
    records.splice(index, 1);
}
function getValue(buttonId) {
    const splits = buttonId.split('-');
    if(splits.length !== 3) { throw 'fatal error.'; }
    let val = parseInt(splits[1], 10);
    val *= splits[0] === 'plus' ? 1 : -1;
    return val;
}
function saveRecords() {
    const json = JSON.stringify(records);
    localStorage.setItem(localStrageKey, json);
}
function loadRecords() {    
    const val = localStorage.getItem(localStrageKey);
    if(val) {
        records = JSON.parse(val);
    }    
}
function updateView() {
    const duration = 300;
    if(selectedDisplay === 'none') {
        $('#posession-display').removeClass('selected');
        $('#role-display').removeClass('selected');
        $('#posession-input').hide(duration);
        $('#role-input').hide(duration);
        $('#number-input').hide(duration);
    } else if(selectedDisplay === 'posession') {
        $('#posession-display').addClass('selected');
        $('#role-display').removeClass('selected');
        $('#posession-input').show(duration);
        $('#role-input').hide(duration);
        $('#number-input').show(duration);
    } else if(selectedDisplay === 'role') {
        $('#posession-display').removeClass('selected');
        $('#role-display').addClass('selected');
        $('#posession-input').hide(duration);
        $('#role-input').show(duration);
        $('#number-input').show(duration);
    }
    $('#posession-span').text(displayPosession);
    $('#role-span').text(displayRole);

    // all rate
    let allRateHtml = '--';
    let posession = 0, role = 0;
    for(let i = 0; i < records.length; i++) {
        const { begin, end } = records[i];
        // calc rate
        if(end) {
            role += (end.role - begin.role);
            posession += (begin.posession - end.posession);
        } 
    }
    if(posession) {
        const rate = role / posession * 250;
        allRateHtml = rate.toFixed(2);
    }
    $('#all-rate').html(allRateHtml);

    // table
    let recordHtml = '';
    for(let i = records.length - 1; i >= 0; i--) {
        const { begin, end } = records[i];
        // calc rate
        let rate = '--';
        if(end) {
            rate = (end.role - begin.role) / (begin.posession - end.posession) * 250;
            rate = rate.toFixed(2);
        } 
        recordHtml += '<tr>';
        recordHtml += `<td>${rate}</td>`;
        recordHtml += `<td>${begin.posession}</td>`;
        recordHtml += `<td>${begin.role}</td>`;
        if(end) {
            recordHtml += `<td>${end.posession}</td>`;
            recordHtml += `<td>${end.role}</td>`;
        } else {
            recordHtml += `<td>${'--'}</td>`;
            recordHtml += `<td>${'--'}</td>`;
        }
        recordHtml += `<td><button id="${i}-delete-button" class="delete-button">delete</button></td>`;
        recordHtml += '</tr>';
    }
    $('#record-table tbody').html(recordHtml);
}
</script>
</head>
<body>  
    <div id="posession-display" class="display">
        <span class="display-title">Posession</span>
        <span id="posession-span"></span>
    </div>
    <div id="role-display" class="display">
        <span class="display-title">Role</span>
        <span id="role-span">0345</span>
    </div>
    <div id="posession-input" class="mt-8">
        <div>
            <button id="minus-125-button" class="minus">-125</button>
            <button id="minus-250-button" class="minus">-250</button>
            <button id="minus-500-button" class="minus">-500</button>
        </div>
        <div class="mt-8">
            <button id="plus-125-button" class="plus">+125</button>
            <button id="plus-250-button" class="plus">+250</button>
            <button id="plus-500-button" class="plus">+500</button>
        </div>        
    </div>
    <div id="role-input" class="mt-8">
        <div>
            <button id="plus-1-button" class="plus">+1</button>
            <button id="plus-5-button" class="plus">+5</button>
            <button id="plus-10-button" class="plus">+10</button>
        </div>
        <div class="mt-8">
            <button id="minus-1-button" class="minus">-1</button>
            <button id="minus-5-button" class="minus">-5</button>
            <button id="minus-10-button" class="minus">-10</button>
        </div>        
    </div>
    <div id="number-input" class="mt-8">        
        <div id="123-numbers">
            <button id="1-button">1</button>
            <button id="2-button">2</button>
            <button id="3-button">3</button>
        </div>
        <div id="456-numbers">
            <button id="4-button">4</button>
            <button id="5-button">5</button>
            <button id="6-button">6</button>
        </div>
        <div id="789-numbers">            
            <button id="7-button">7</button>
            <button id="8-button">8</button>
            <button id="9-button">9</button>
        </div>
        <button id="0-button">0</button>        
    </div>
    <div>
        <button id="start-button">Start</button>&nbsp;
        <button id="end-button">End</button>&nbsp;
        <button id="reset-button">Reset</button>    
    </div>
    <div><span id="all-rate"></span></div>
    <div class="mt-8">
        <table id="record-table">
            <thead>
                <tr>
                    <th>avg</th>
                    <th colspan="2">start</th>
                    <th colspan="2">end</th>
                    <th>delete</th>
                </tr> 
            </thead>
            <tbody></tbody>
        </table>
    </div>
</body>
</html>