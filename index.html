<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
.number-input {
    font-size: 80px;
}
#posession-input {
    width: 320px;
}
#role-input {
    width: 240px;
}
#over-input {
    width: 180px;
}
button {
    font-size: 48px;
    font-weight: bold;
    padding: 12px;
}
#start-button, #end-button, #reset-button {
    font-size: 64px;
    width: 260px;
    padding: 24px;
}
.minus {
    background-color: lightblue;
}
.plus {
    background-color: salmon;
}
.selected {
    background-color: yellow;
}
html {
  touch-action: manipulation;
}
.mt-8 {
    margin-top: 8px;
}
.ml-8 {
    margin-left: 8px;
}
#record-table {
    font-size: 40px;
    border-collapse: collapse;
}
#all-rate {
    font-size: 80px;
    font-weight: bold;
}
#record-table th, #record-table td {
    border: 2px solid #888;
    text-align: center;
    width: 140px;
}
</style>
<script>
const localStrageKey = 'record-key';
let records = [];
$(init);
function init() {
    loadRecords();
    attachEvents();
    updateView();
}
function attachEvents() {
    $('#over-input').change(() => {
        saveRecords();
        updateView();
    });
    $('#start-button').click(() => {
        clickStartButton();
        saveRecords();
        updateView();
    });
    $('#end-button').click(() => {
        clickEndButton();
        saveRecords();
        updateView();
    });
    $('#reset-button').click(() => {
        clickResetButton();
        saveRecords();
        updateView();
    });
    $(document).on('click', '.delete-button', e => {
        clickDeleteButton(e);
        saveRecords();
        updateView();
    });
}
function checkInputs() {
    return $('#posession-input').val() === '' || $('#role-input').val() === '';
}
function toggleEnabled() {
    if(records.length === 0) {
        $('#start-button').prop('disabled', false);
        $('#end-button').prop('disabled', true);
    } else if(!records[records.length - 1].end) {
        $('#start-button').prop('disabled', true);
        $('#end-button').prop('disabled', false);
    } else{
        $('#start-button').prop('disabled', false);
        $('#end-button').prop('disabled', false);
    }
}
function clickStartButton() {
    if(checkInputs()) {
        alert('No input.');
        return;
    }
    const record = {
        begin: {
            posession: parseInt($('#posession-input').val(), 10),
            role: parseInt($('#role-input').val(), 10),
        },
        end: null,
    };
    if(records.length && records[records.length - 1].end === null) {
        records[records.length - 1] = record;
    } else {
        records.push(record);
    }
}
function clickEndButton() {
    if(checkInputs()) {
        alert('No input.');
        return;
    }
    if(!records.length) { return; }
    records[records.length - 1].end = {
        posession: parseInt($('#posession-input').val(), 10),
        role: parseInt($('#role-input').val(), 10),
    };
}
function clickResetButton() {
    if(confirm('Do you want to reset?')) {
        records = [];
    }    
}
function clickDeleteButton(e) {
    if(!confirm('Do you want to delete?')) { return; }
    const buttonId = e.target.id;
    const splits = buttonId.split('-');
    if(splits.length !== 3) { throw 'fatal error.'; }
    const index = parseInt(splits[0], 10);
    records.splice(index, 1);
}
function saveRecords() {
    const json = JSON.stringify(records);
    localStorage.setItem(localStrageKey, json);
}
function loadRecords() {    
    const val = localStorage.getItem(localStrageKey);
    if(val) {
        records = JSON.parse(val);
    }    
}
function updateView() {
    toggleEnabled();
    // all rate
    let allRateHtml = '--';
    let posession = 0, role = 0;
    for(let i = 0; i < records.length; i++) {
        const { begin, end } = records[i];
        // calc rate
        if(end) {
            role += (end.role - begin.role);
            posession += (begin.posession - end.posession);
        } 
    }
    if(posession) {
        // add role
        let over = parseInt($('#over-input').val());
        if(isNaN(over)) { over = 0; }
        const rate = (role + over) / posession * 250;
        allRateHtml = rate.toFixed(2);        
        allRateHtml += ` (${role} roles)`;
    }
    $('#all-rate').html(allRateHtml);

    // table
    let recordHtml = '';
    for(let i = records.length - 1; i >= 0; i--) {
        const { begin, end } = records[i];
        // calc rate
        let rate = '--';
        if(end) {
            rate = (end.role - begin.role) / (begin.posession - end.posession) * 250;
            rate = rate.toFixed(2);
        }         
        recordHtml += '<tr>';
        recordHtml += `<td>${rate}</td>`;
        recordHtml += `<td>${begin.posession}</td>`;
        recordHtml += `<td>${begin.role}</td>`;
        if(end) {
            recordHtml += `<td>${end.posession}</td>`;
            recordHtml += `<td>${end.role}</td>`;
        } else {
            recordHtml += `<td>${'--'}</td>`;
            recordHtml += `<td>${'--'}</td>`;
        }
        recordHtml += `<td><button id="${i}-delete-button" class="delete-button">delete</button></td>`;
        recordHtml += '</tr>';
    }
    $('#record-table tbody').html(recordHtml);
}
</script>
</head>
<body>  
    <input id="posession-input" class="number-input" type="number" min="-999999" max="999999"/>
    <input id="role-input" class="number-input ml-8" type="number" min="0" max="9999"/>
    <input id="over-input" class="number-input ml-8" type="number" min="0" max="9999"/>
    <div class="mt-8">
        <button id="start-button">Start</button>
        <button id="end-button">End</button>
        <button id="reset-button">Reset</button>
    </div>
    <div><span id="all-rate"></span></div>
    <div class="mt-8">
        <table id="record-table">
            <thead>
                <tr>
                    <th>avg</th>
                    <th colspan="2">start</th>
                    <th colspan="2">end</th>
                    <th>delete</th>
                </tr> 
            </thead>
            <tbody></tbody>
        </table>
    </div>
</body>
</html>